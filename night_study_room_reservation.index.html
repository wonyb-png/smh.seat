<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>야자실 예약 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .time-slot {
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-slot:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .time-slot.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .seat-map {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
            border: 2px solid #e0e0e0;
        }

        .seat-map h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #667eea;
            font-size: 1.3em;
        }

        .classroom {
            display: grid;
            gap: 15px;
            max-width: 900px;
            margin: 0 auto;
        }

        .teacher-vertical {
            grid-row: 1 / 3;
            grid-column: 1;
        }

        .row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .row.first-rows {
            display: contents;
        }

        .row.last-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .seat {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            font-size: 0.9em;
            padding: 5px;
        }

        .seat:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .seat.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .seat.reserved {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .seat.reserved:hover {
            transform: none;
            border-color: #e0e0e0;
        }

        .seat-number {
            font-weight: bold;
            font-size: 1.1em;
        }

        .empty-seat {
            background: transparent;
            border: none;
            cursor: default;
        }

        .empty-seat:hover {
            transform: none;
            border: none;
        }

        .teacher-desk {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border: 2px dashed #999;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            color: #666;
            border-radius: 8px;
        }

        .special-item {
            background: #f0f0f0;
            border: 2px solid #999;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            color: #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
        }

        .pillar {
            background: #d0d0d0;
            border: 2px solid #888;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            color: #555;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recycling {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            color: #2e7d32;
        }

        .decoration {
            background: #fff3e0;
            border: 2px solid #ff9800;
            color: #e65100;
        }

        .btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-export {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            width: 100%;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .reservations-list {
            margin-top: 30px;
        }

        .reservation-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            position: relative;
        }

        .reservation-info {
            flex: 1;
        }

        .reservation-info h3 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .reservation-info p {
            color: #666;
            margin: 5px 0;
        }

        .cancel-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .cancel-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .cancel-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .cancel-input:focus {
            outline: none;
            border-color: #dc3545;
        }

        .btn-cancel-confirm {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            white-space: nowrap;
        }

        .btn-cancel-confirm:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-box {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #e0e0e0;
        }

        .legend-box.available {
            background: white;
        }

        .legend-box.selected {
            background: #667eea;
            border-color: #667eea;
        }

        .legend-box.reserved {
            background: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>2학년 야간자율학습 좌석 예약</h1>
            <p>원하는 날짜, 시간대, 좌석을 선택하여 예약하세요 (19:00 - 21:00)</p>
        </div>

        <div class="content">
            <div class="form-section">
                <h2 style="margin-bottom: 20px;">예약하기</h2>
                
                <div class="form-group">
                    <label for="studentName">학생 이름</label>
                    <input type="text" id="studentName" placeholder="이름을 입력하세요">
                </div>

                <div class="form-group">
                    <label for="classNum">반</label>
                    <input type="number" id="classNum" placeholder="반을 입력하세요" min="1">
                </div>

                <div class="form-group">
                    <label for="studentNum">번호</label>
                    <input type="number" id="studentNum" placeholder="번호를 입력하세요" min="1">
                </div>

                <div class="form-group">
                    <label for="reservationDate">날짜</label>
                    <input type="date" id="reservationDate" readonly>
                </div>

                <div class="form-group">
                    <label>시간대 선택</label>
                    <div class="time-slots" id="timeSlots">
                        <div class="time-slot" data-time="19:00-20:00">19:00-20:00</div>
                        <div class="time-slot" data-time="20:00-21:00">20:00-21:00</div>
                    </div>
                </div>

                <div class="seat-map">
                    <h3>좌석 선택</h3>
                    <div class="classroom" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;">
                        <!-- 선생님 자리 (세로로 2칸) -->
                        <div class="special-item teacher-desk" style="grid-row: 1 / 3; grid-column: 1;">선생님<br>자리</div>
                        
                        <!-- 1열 나머지 -->
                        <div class="seat" data-seat="1"><span class="seat-number">1</span></div>
                        <div class="seat" data-seat="2"><span class="seat-number">2</span></div>
                        <div class="seat" data-seat="3"><span class="seat-number">3</span></div>
                        <div class="seat" data-seat="4"><span class="seat-number">4</span></div>
                        <div class="seat" data-seat="5"><span class="seat-number">5</span></div>
                        <div class="seat" data-seat="6"><span class="seat-number">6</span></div>

                        <!-- 2열 -->
                        <div class="seat" data-seat="7"><span class="seat-number">7</span></div>
                        <div class="seat" data-seat="8"><span class="seat-number">8</span></div>
                        <div class="seat" data-seat="9"><span class="seat-number">9</span></div>
                        <div class="seat" data-seat="10"><span class="seat-number">10</span></div>
                        <div class="seat" data-seat="11"><span class="seat-number">11</span></div>
                        <div class="seat" data-seat="12"><span class="seat-number">12</span></div>

                        <!-- 3열 -->
                        <div class="seat" data-seat="13"><span class="seat-number">13</span></div>
                        <div class="seat" data-seat="14"><span class="seat-number">14</span></div>
                        <div class="seat" data-seat="15"><span class="seat-number">15</span></div>
                        <div class="seat" data-seat="16"><span class="seat-number">16</span></div>
                        <div class="seat" data-seat="17"><span class="seat-number">17</span></div>
                        <div class="pillar special-item">기둥</div>
                        <div class="seat" data-seat="18"><span class="seat-number">18</span></div>

                        <!-- 4열 -->
                        <div class="seat" data-seat="19"><span class="seat-number">19</span></div>
                        <div class="seat" data-seat="20"><span class="seat-number">20</span></div>
                        <div class="seat" data-seat="21"><span class="seat-number">21</span></div>
                        <div class="seat" data-seat="22"><span class="seat-number">22</span></div>
                        <div class="seat" data-seat="23"><span class="seat-number">23</span></div>
                        <div class="pillar special-item">기둥</div>
                        <div class="seat" data-seat="24"><span class="seat-number">24</span></div>

                        <!-- 5열 -->
                        <div class="seat" data-seat="25"><span class="seat-number">25</span></div>
                        <div class="seat" data-seat="26"><span class="seat-number">26</span></div>
                        <div class="seat" data-seat="27"><span class="seat-number">27</span></div>
                        <div class="seat" data-seat="28"><span class="seat-number">28</span></div>
                        <div class="seat" data-seat="29"><span class="seat-number">29</span></div>
                        <div class="seat" data-seat="30"><span class="seat-number">30</span></div>
                        <div class="seat" data-seat="31"><span class="seat-number">31</span></div>

                        <!-- 6열 -->
                        <div class="seat" data-seat="32"><span class="seat-number">32</span></div>
                        <div class="seat" data-seat="33"><span class="seat-number">33</span></div>
                        <div class="seat" data-seat="34"><span class="seat-number">34</span></div>
                        <div class="seat" data-seat="35"><span class="seat-number">35</span></div>
                        <div class="seat" data-seat="36"><span class="seat-number">36</span></div>
                        <div class="seat" data-seat="37"><span class="seat-number">37</span></div>
                        <div class="seat" data-seat="38"><span class="seat-number">38</span></div>

                        <!-- 7열 -->
                        <div class="special-item pillar" style="grid-column: 1 / 3;">냉난방기</div>
                        <div class="seat" data-seat="39"><span class="seat-number">39</span></div>
                        <div class="seat" data-seat="40"><span class="seat-number">40</span></div>
                        <div class="seat" data-seat="41"><span class="seat-number">41</span></div>
                        <div class="seat" data-seat="42"><span class="seat-number">42</span></div>
                        <div class="seat" data-seat="43"><span class="seat-number">43</span></div>
                    </div>

                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-box available"></div>
                            <span>선택 가능</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box selected"></div>
                            <span>선택됨</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box reserved"></div>
                            <span>예약됨</span>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="makeReservation()">예약하기</button>
                <button class="btn btn-export" onclick="exportToExcel()">오늘 예약자 명단 엑셀로 다운로드</button>
            </div>

            <div class="reservations-list">
                <h2 style="margin-bottom: 20px;">예약 현황</h2>
                <div id="reservationsList"></div>
            </div>
        </div>
    </div>

    <script>
        let reservations = [];
        let selectedTimes = [];
        let selectedSeat = null;

        // 오늘 날짜를 고정으로 설정
        const today = new Date();
        const dateInput = document.getElementById('reservationDate');
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const todayString = `${year}-${month}-${day}`;
        dateInput.value = todayString;
        dateInput.min = todayString;
        dateInput.max = todayString;

        // 시간대 선택 (2개까지 선택 가능)
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.addEventListener('click', function() {
                const time = this.dataset.time;
                
                if (this.classList.contains('selected')) {
                    // 이미 선택된 경우 선택 해제
                    this.classList.remove('selected');
                    selectedTimes = selectedTimes.filter(t => t !== time);
                } else {
                    // 선택 추가
                    this.classList.add('selected');
                    selectedTimes.push(time);
                }
                
                updateSeatAvailability();
            });
        });

        // 좌석 선택
        document.querySelectorAll('.seat:not(.empty-seat)').forEach(seat => {
            seat.addEventListener('click', function() {
                if (this.classList.contains('reserved')) return;
                
                document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
                this.classList.add('selected');
                selectedSeat = this.dataset.seat;
            });
        });

        function updateSeatAvailability() {
            const date = document.getElementById('reservationDate').value;
            
            if (!date || selectedTimes.length === 0) return;

            // 모든 좌석 초기화
            document.querySelectorAll('.seat:not(.empty-seat)').forEach(seat => {
                seat.classList.remove('reserved', 'selected');
            });

            // 선택한 모든 시간대에 대해 예약된 좌석 표시
            selectedTimes.forEach(time => {
                reservations.forEach(r => {
                    if (r.date === date && r.seat) {
                        const seatElement = document.querySelector(`.seat[data-seat="${r.seat}"]`);
                        if (seatElement) {
                            // 통합 예약(19:00-21:00)이면 두 시간대 모두 예약됨
                            if (r.isCombined && (time === '19:00-20:00' || time === '20:00-21:00')) {
                                seatElement.classList.add('reserved');
                            }
                            // 개별 예약이면 해당 시간대만 예약됨
                            else if (!r.isCombined && r.time === time) {
                                seatElement.classList.add('reserved');
                            }
                        }
                    }
                });
            });

            selectedSeat = null;
        }

        // 날짜 변경 시 좌석 업데이트
        document.getElementById('reservationDate').addEventListener('change', updateSeatAvailability);

        function makeReservation() {
            const name = document.getElementById('studentName').value;
            const classNum = document.getElementById('classNum').value;
            const studentNum = document.getElementById('studentNum').value;
            const date = document.getElementById('reservationDate').value;
            const room = '융합실';
            const grade = '2';

            if (!name || !classNum || !studentNum || !date || selectedTimes.length === 0 || !selectedSeat) {
                alert('모든 정보를 입력하고 시간대와 좌석을 선택해주세요!');
                return;
            }

            // 각 시간대별로 중복 체크
            for (let time of selectedTimes) {
                const duplicate = reservations.find(r => 
                    r.date === date && r.time === time && r.seat === selectedSeat
                );

                if (duplicate) {
                    alert(`${time} 시간대에 이미 예약된 좌석입니다!`);
                    return;
                }
            }

            // 2개 시간대를 선택한 경우 19:00-21:00으로 통합
            if (selectedTimes.length === 2) {
                const reservation = {
                    id: Date.now() + Math.random(),
                    name,
                    grade,
                    classNum,
                    studentNum,
                    date,
                    room,
                    time: '19:00-21:00',
                    seat: selectedSeat,
                    isCombined: true
                };
                reservations.push(reservation);
            } else {
                // 1개 시간대만 선택한 경우 개별 예약
                selectedTimes.forEach(time => {
                    const reservation = {
                        id: Date.now() + Math.random(),
                        name,
                        grade,
                        classNum,
                        studentNum,
                        date,
                        room,
                        time: time,
                        seat: selectedSeat,
                        isCombined: false
                    };
                    reservations.push(reservation);
                });
            }

            displayReservations();
            updateSeatAvailability();
            clearForm();
            alert('예약이 완료되었습니다!');
        }

        function displayReservations() {
            const listDiv = document.getElementById('reservationsList');
            
            if (reservations.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">예약 내역이 없습니다.</div>';
                return;
            }

            // 날짜, 시간 순으로 정렬
            const sortedReservations = [...reservations].sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.time.localeCompare(b.time);
            });

            listDiv.innerHTML = sortedReservations.map(r => `
                <div class="reservation-card">
                    <div class="reservation-info">
                        <h3>${r.name} (${r.grade}학년 ${r.classNum}반 ${r.studentNum}번)</h3>
                        <p>${r.room} - 좌석: ${r.seat}번</p>
                        <p>${r.date}</p>
                        <p>${r.time}</p>
                    </div>
                    <div class="cancel-section">
                        <p style="color: #999; font-size: 14px; margin-bottom: 8px;">예약 취소를 원하시면 이름을 입력하세요:</p>
                        <div class="cancel-input-group">
                            <input type="text" class="cancel-input" id="cancel-${r.id}" placeholder="이름 입력">
                            <button class="btn-cancel-confirm" onclick="confirmCancelReservation(${r.id}, '${r.name}')">취소하기</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function confirmCancelReservation(id, originalName) {
            const inputName = document.getElementById(`cancel-${id}`).value.trim();
            
            if (!inputName) {
                alert('이름을 입력해주세요.');
                return;
            }

            if (inputName !== originalName) {
                alert('예약자 이름과 일치하지 않습니다.');
                document.getElementById(`cancel-${id}`).value = '';
                return;
            }

            if (confirm('정말 예약을 취소하시겠습니까?')) {
                // 통합 예약(19:00-21:00)인 경우 해당 예약만 삭제
                reservations = reservations.filter(r => r.id !== id);
                displayReservations();
                updateSeatAvailability();
                alert('예약이 취소되었습니다.');
            }
        }

        function clearForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('classNum').value = '';
            document.getElementById('studentNum').value = '';
            document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
            document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
            selectedTimes = [];
            selectedSeat = null;
        }

        function exportToExcel() {
            // 비밀번호 확인
            const password = prompt('엑셀 다운로드 비밀번호를 입력하세요:');
            
            if (password === null) {
                // 취소 버튼 클릭
                return;
            }
            
            if (password !== '0000') {
                alert('비밀번호가 올바르지 않습니다.');
                return;
            }
            
            const date = document.getElementById('reservationDate').value;
            
            // 오늘 날짜의 예약만 필터링
            const todayReservations = reservations.filter(r => r.date === date);
            
            if (todayReservations.length === 0) {
                alert('오늘 예약 내역이 없습니다.');
                return;
            }

            // 엑셀 데이터 생성
            let csvContent = '\uFEFF'; // UTF-8 BOM
            csvContent += '날짜,시간대,이름,학년,반,번호,좌석번호\n';
            
            // 정렬 (시간대, 좌석 순)
            const sortedReservations = [...todayReservations].sort((a, b) => {
                if (a.time !== b.time) return a.time.localeCompare(b.time);
                return parseInt(a.seat) - parseInt(b.seat);
            });
            
            sortedReservations.forEach(r => {
                csvContent += `${r.date},${r.time},${r.name},${r.grade}학년,${r.classNum}반,${r.studentNum}번,${r.seat}번\n`;
            });

            // 파일 다운로드
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `야자실예약_${date}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`${todayReservations.length}건의 예약 내역을 다운로드했습니다.`);
        }

        // 초기 표시 
        displayReservations();
    </script>
</body>
</html>
