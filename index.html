<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>야자실 예약 시스템</title>
    <style>
        /* 기존 CSS 그대로 유지 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        /* ... 나머지 CSS 동일 ... */
    </style>
</head>
<body>
    <!-- 기존 HTML 내용 그대로 -->
    
    <!-- Firebase SDK 추가 (</body> 태그 바로 위에) -->
    <script type="module">
        // Firebase SDK 임포트
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase 구성 (Firebase Console에서 복사한 내용으로 교체)
        const firebaseConfig = {
            apiKey: "AIzaSyDPnOtTMW-w6LD0hggKcFkYNGyJOPq1tEg",
            authDomain: "night-study-room-reservation.firebaseapp.com",
            projectId: "night-study-room-reservation",
            storageBucket: "night-study-room-reservation.firebasestorage.app",
            messagingSenderId: "460809823747",
            appId: "1:460809823747:web:9d76154d519d0e40b89036",
            measurementId: "G-2L4SS21JQL"
        };


        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let selectedTimes = [];
        let selectedSeat = null;

        // 오늘 날짜 설정
        const today = new Date();
        const dateInput = document.getElementById('reservationDate');
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const todayString = `${year}-${month}-${day}`;
        dateInput.value = todayString;
        dateInput.min = todayString;
        dateInput.max = todayString;

        // 시간대 선택
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.addEventListener('click', function() {
                const time = this.dataset.time;
                
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    selectedTimes = selectedTimes.filter(t => t !== time);
                } else {
                    this.classList.add('selected');
                    selectedTimes.push(time);
                }
                
                updateSeatAvailability();
            });
        });

        // 좌석 선택
        document.querySelectorAll('.seat:not(.empty-seat)').forEach(seat => {
            seat.addEventListener('click', function() {
                if (this.classList.contains('reserved')) return;
                
                document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
                this.classList.add('selected');
                selectedSeat = this.dataset.seat;
            });
        });

        // Firebase에서 예약 데이터 로드
        async function loadReservations() {
            const reservationsCol = collection(db, 'reservations');
            const reservationSnapshot = await getDocs(reservationsCol);
            const reservationsList = reservationSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            displayReservations(reservationsList);
            return reservationsList;
        }

        // 좌석 가용성 업데이트
        async function updateSeatAvailability() {
            const date = document.getElementById('reservationDate').value;
            
            if (!date || selectedTimes.length === 0) return;

            document.querySelectorAll('.seat:not(.empty-seat)').forEach(seat => {
                seat.classList.remove('reserved', 'selected');
            });

            const reservations = await loadReservations();

            selectedTimes.forEach(time => {
                reservations.forEach(r => {
                    if (r.date === date && r.seat) {
                        const seatElement = document.querySelector(`.seat[data-seat="${r.seat}"]`);
                        if (seatElement) {
                            if (r.isCombined && (time === '19:00-20:00' || time === '20:00-21:00')) {
                                seatElement.classList.add('reserved');
                            }
                            else if (!r.isCombined && r.time === time) {
                                seatElement.classList.add('reserved');
                            }
                        }
                    }
                });
            });

            selectedSeat = null;
        }

        dateInput.addEventListener('change', updateSeatAvailability);

        // 예약 생성
        window.makeReservation = async function() {
            const name = document.getElementById('studentName').value;
            const classNum = document.getElementById('classNum').value;
            const studentNum = document.getElementById('studentNum').value;
            const date = document.getElementById('reservationDate').value;
            const room = '융합실';
            const grade = '2';

            if (!name || !classNum || !studentNum || !date || selectedTimes.length === 0 || !selectedSeat) {
                alert('모든 정보를 입력하고 시간대와 좌석을 선택해주세요!');
                return;
            }

            // 중복 체크
            const reservations = await loadReservations();
            for (let time of selectedTimes) {
                const duplicate = reservations.find(r => 
                    r.date === date && r.time === time && r.seat === selectedSeat
                );

                if (duplicate) {
                    alert(`${time} 시간대에 이미 예약된 좌석입니다!`);
                    return;
                }
            }

            try {
                // Firebase에 예약 저장
                if (selectedTimes.length === 2) {
                    await addDoc(collection(db, 'reservations'), {
                        name,
                        grade,
                        classNum,
                        studentNum,
                        date,
                        room,
                        time: '19:00-21:00',
                        seat: selectedSeat,
                        isCombined: true,
                        createdAt: new Date().toISOString()
                    });
                } else {
                    for (let time of selectedTimes) {
                        await addDoc(collection(db, 'reservations'), {
                            name,
                            grade,
                            classNum,
                            studentNum,
                            date,
                            room,
                            time: time,
                            seat: selectedSeat,
                            isCombined: false,
                            createdAt: new Date().toISOString()
                        });
                    }
                }

                await loadReservations();
                await updateSeatAvailability();
                clearForm();
                alert('예약이 완료되었습니다!');
            } catch (error) {
                console.error('예약 실패:', error);
                alert('예약 중 오류가 발생했습니다.');
            }
        };

        // 예약 현황 표시
        function displayReservations(reservations) {
            const listDiv = document.getElementById('reservationsList');
            
            if (reservations.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">예약 내역이 없습니다.</div>';
                return;
            }

            const sortedReservations = [...reservations].sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.time.localeCompare(b.time);
            });

            listDiv.innerHTML = sortedReservations.map(r => `
                <div class="reservation-card">
                    <div class="reservation-info">
                        <h3>${r.name} (${r.grade}학년 ${r.classNum}반 ${r.studentNum}번)</h3>
                        <p>${r.room} - 좌석: ${r.seat}번</p>
                        <p>${r.date}</p>
                        <p>${r.time}</p>
                    </div>
                    <div class="cancel-section">
                        <p style="color: #999; font-size: 14px; margin-bottom: 8px;">예약 취소를 원하시면 이름을 입력하세요:</p>
                        <div class="cancel-input-group">
                            <input type="text" class="cancel-input" id="cancel-${r.id}" placeholder="이름 입력">
                            <button class="btn-cancel-confirm" onclick="confirmCancelReservation('${r.id}', '${r.name}')">취소하기</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 예약 취소
        window.confirmCancelReservation = async function(id, originalName) {
            const inputName = document.getElementById(`cancel-${id}`).value.trim();
            
            if (!inputName) {
                alert('이름을 입력해주세요.');
                return;
            }

            if (inputName !== originalName) {
                alert('예약자 이름과 일치하지 않습니다.');
                document.getElementById(`cancel-${id}`).value = '';
                return;
            }

            if (confirm('정말 예약을 취소하시겠습니까?')) {
                try {
                    await deleteDoc(doc(db, 'reservations', id));
                    await loadReservations();
                    await updateSeatAvailability();
                    alert('예약이 취소되었습니다.');
                } catch (error) {
                    console.error('취소 실패:', error);
                    alert('취소 중 오류가 발생했습니다.');
                }
            }
        };

        // 폼 초기화
        function clearForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('classNum').value = '';
            document.getElementById('studentNum').value = '';
            document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
            document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
            selectedTimes = [];
            selectedSeat = null;
        }

        // 엑셀 다운로드
        window.exportToExcel = async function() {
            const password = prompt('엑셀 다운로드 비밀번호를 입력하세요:');
            
            if (password === null) return;
            
            if (password !== '0000') {
                alert('비밀번호가 올바르지 않습니다.');
                return;
            }
            
            const date = document.getElementById('reservationDate').value;
            const reservations = await loadReservations();
            const todayReservations = reservations.filter(r => r.date === date);
            
            if (todayReservations.length === 0) {
                alert('오늘 예약 내역이 없습니다.');
                return;
            }

            let csvContent = '\uFEFF';
            csvContent += '날짜,시간대,이름,학년,반,번호,좌석번호\n';
            
            const sortedReservations = [...todayReservations].sort((a, b) => {
                if (a.time !== b.time) return a.time.localeCompare(b.time);
                return parseInt(a.seat) - parseInt(b.seat);
            });
            
            sortedReservations.forEach(r => {
                csvContent += `${r.date},${r.time},${r.name},${r.grade}학년,${r.classNum}반,${r.studentNum}번,${r.seat}번\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `야자실예약_${date}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`${todayReservations.length}건의 예약 내역을 다운로드했습니다.`);
        };

        // 페이지 로드 시 예약 목록 불러오기
        loadReservations();
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>야자실 예약 시스템</title>
    <style>
        /* 기존 CSS 그대로 유지 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        /* ... 나머지 CSS 동일 ... */
    </style>
</head>
<body>
    <!-- 기존 HTML 내용 그대로 -->
    
    <!-- Firebase SDK 추가 (</body> 태그 바로 위에) -->
    <script type="module">
        // Firebase SDK 임포트
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase 구성 (Firebase Console에서 복사한 내용으로 교체)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let selectedTimes = [];
        let selectedSeat = null;

        // 오늘 날짜 설정
        const today = new Date();
        const dateInput = document.getElementById('reservationDate');
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const todayString = `${year}-${month}-${day}`;
        dateInput.value = todayString;
        dateInput.min = todayString;
        dateInput.max = todayString;

        // 시간대 선택
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.addEventListener('click', function() {
                const time = this.dataset.time;
                
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    selectedTimes = selectedTimes.filter(t => t !== time);
                } else {
                    this.classList.add('selected');
                    selectedTimes.push(time);
                }
                
                updateSeatAvailability();
            });
        });

        // 좌석 선택
        document.querySelectorAll('.seat:not(.empty-seat)').forEach(seat => {
            seat.addEventListener('click', function() {
                if (this.classList.contains('reserved')) return;
                
                document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
                this.classList.add('selected');
                selectedSeat = this.dataset.seat;
            });
        });

        // Firebase에서 예약 데이터 로드
        async function loadReservations() {
            const reservationsCol = collection(db, 'reservations');
            const reservationSnapshot = await getDocs(reservationsCol);
            const reservationsList = reservationSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            displayReservations(reservationsList);
            return reservationsList;
        }

        // 좌석 가용성 업데이트
        async function updateSeatAvailability() {
            const date = document.getElementById('reservationDate').value;
            
            if (!date || selectedTimes.length === 0) return;

            document.querySelectorAll('.seat:not(.empty-seat)').forEach(seat => {
                seat.classList.remove('reserved', 'selected');
            });

            const reservations = await loadReservations();

            selectedTimes.forEach(time => {
                reservations.forEach(r => {
                    if (r.date === date && r.seat) {
                        const seatElement = document.querySelector(`.seat[data-seat="${r.seat}"]`);
                        if (seatElement) {
                            if (r.isCombined && (time === '19:00-20:00' || time === '20:00-21:00')) {
                                seatElement.classList.add('reserved');
                            }
                            else if (!r.isCombined && r.time === time) {
                                seatElement.classList.add('reserved');
                            }
                        }
                    }
                });
            });

            selectedSeat = null;
        }

        dateInput.addEventListener('change', updateSeatAvailability);

        // 예약 생성
        window.makeReservation = async function() {
            const name = document.getElementById('studentName').value;
            const classNum = document.getElementById('classNum').value;
            const studentNum = document.getElementById('studentNum').value;
            const date = document.getElementById('reservationDate').value;
            const room = '융합실';
            const grade = '2';

            if (!name || !classNum || !studentNum || !date || selectedTimes.length === 0 || !selectedSeat) {
                alert('모든 정보를 입력하고 시간대와 좌석을 선택해주세요!');
                return;
            }

            // 중복 체크
            const reservations = await loadReservations();
            for (let time of selectedTimes) {
                const duplicate = reservations.find(r => 
                    r.date === date && r.time === time && r.seat === selectedSeat
                );

                if (duplicate) {
                    alert(`${time} 시간대에 이미 예약된 좌석입니다!`);
                    return;
                }
            }

            try {
                // Firebase에 예약 저장
                if (selectedTimes.length === 2) {
                    await addDoc(collection(db, 'reservations'), {
                        name,
                        grade,
                        classNum,
                        studentNum,
                        date,
                        room,
                        time: '19:00-21:00',
                        seat: selectedSeat,
                        isCombined: true,
                        createdAt: new Date().toISOString()
                    });
                } else {
                    for (let time of selectedTimes) {
                        await addDoc(collection(db, 'reservations'), {
                            name,
                            grade,
                            classNum,
                            studentNum,
                            date,
                            room,
                            time: time,
                            seat: selectedSeat,
                            isCombined: false,
                            createdAt: new Date().toISOString()
                        });
                    }
                }

                await loadReservations();
                await updateSeatAvailability();
                clearForm();
                alert('예약이 완료되었습니다!');
            } catch (error) {
                console.error('예약 실패:', error);
                alert('예약 중 오류가 발생했습니다.');
            }
        };

        // 예약 현황 표시
        function displayReservations(reservations) {
            const listDiv = document.getElementById('reservationsList');
            
            if (reservations.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">예약 내역이 없습니다.</div>';
                return;
            }

            const sortedReservations = [...reservations].sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.time.localeCompare(b.time);
            });

            listDiv.innerHTML = sortedReservations.map(r => `
                <div class="reservation-card">
                    <div class="reservation-info">
                        <h3>${r.name} (${r.grade}학년 ${r.classNum}반 ${r.studentNum}번)</h3>
                        <p>${r.room} - 좌석: ${r.seat}번</p>
                        <p>${r.date}</p>
                        <p>${r.time}</p>
                    </div>
                    <div class="cancel-section">
                        <p style="color: #999; font-size: 14px; margin-bottom: 8px;">예약 취소를 원하시면 이름을 입력하세요:</p>
                        <div class="cancel-input-group">
                            <input type="text" class="cancel-input" id="cancel-${r.id}" placeholder="이름 입력">
                            <button class="btn-cancel-confirm" onclick="confirmCancelReservation('${r.id}', '${r.name}')">취소하기</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 예약 취소
        window.confirmCancelReservation = async function(id, originalName) {
            const inputName = document.getElementById(`cancel-${id}`).value.trim();
            
            if (!inputName) {
                alert('이름을 입력해주세요.');
                return;
            }

            if (inputName !== originalName) {
                alert('예약자 이름과 일치하지 않습니다.');
                document.getElementById(`cancel-${id}`).value = '';
                return;
            }

            if (confirm('정말 예약을 취소하시겠습니까?')) {
                try {
                    await deleteDoc(doc(db, 'reservations', id));
                    await loadReservations();
                    await updateSeatAvailability();
                    alert('예약이 취소되었습니다.');
                } catch (error) {
                    console.error('취소 실패:', error);
                    alert('취소 중 오류가 발생했습니다.');
                }
            }
        };

        // 폼 초기화
        function clearForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('classNum').value = '';
            document.getElementById('studentNum').value = '';
            document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
            document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
            selectedTimes = [];
            selectedSeat = null;
        }

        // 엑셀 다운로드
        window.exportToExcel = async function() {
            const password = prompt('엑셀 다운로드 비밀번호를 입력하세요:');
            
            if (password === null) return;
            
            if (password !== '0000') {
                alert('비밀번호가 올바르지 않습니다.');
                return;
            }
            
            const date = document.getElementById('reservationDate').value;
            const reservations = await loadReservations();
            const todayReservations = reservations.filter(r => r.date === date);
            
            if (todayReservations.length === 0) {
                alert('오늘 예약 내역이 없습니다.');
                return;
            }

            let csvContent = '\uFEFF';
            csvContent += '날짜,시간대,이름,학년,반,번호,좌석번호\n';
            
            const sortedReservations = [...todayReservations].sort((a, b) => {
                if (a.time !== b.time) return a.time.localeCompare(b.time);
                return parseInt(a.seat) - parseInt(b.seat);
            });
            
            sortedReservations.forEach(r => {
                csvContent += `${r.date},${r.time},${r.name},${r.grade}학년,${r.classNum}반,${r.studentNum}번,${r.seat}번\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `야자실예약_${date}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`${todayReservations.length}건의 예약 내역을 다운로드했습니다.`);
        };

        // 페이지 로드 시 예약 목록 불러오기
        loadReservations();
    </script>
</body>
</html>
