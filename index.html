<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>야자실 예약 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .time-slot {
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }

        .time-slot:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .time-slot.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .seat-map {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
            border: 2px solid #e0e0e0;
        }

        .seat-map h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #667eea;
            font-size: 1.3em;
        }

        .seat {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            font-size: 0.9em;
            padding: 5px;
            user-select: none;
        }

        .seat:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .seat.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .seat.reserved {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .seat.reserved:hover {
            transform: none;
            border-color: #e0e0e0;
        }

        .seat-number {
            font-weight: bold;
            font-size: 1.1em;
        }

        .special-item {
            background: #f0f0f0;
            border: 2px solid #999;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            color: #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
        }

        .pillar {
            background: #d0d0d0;
            border: 2px solid #888;
        }

        .btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-export {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            width: 100%;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .reservations-list {
            margin-top: 30px;
        }

        .reservation-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .reservation-info h3 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .reservation-info p {
            color: #666;
            margin: 5px 0;
        }

        .cancel-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .cancel-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .cancel-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-cancel-confirm {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            white-space: nowrap;
        }

        .btn-cancel-confirm:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-box {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #e0e0e0;
        }

        .legend-box.available {
            background: white;
        }

        .legend-box.selected {
            background: #667eea;
            border-color: #667eea;
        }

        .legend-box.reserved {
            background: #e0e0e0;
        }

        .date-display {
            background: #fff;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>2학년 야간자율학습 좌석 예약</h1>
            <p>원하는 날짜, 시간대, 좌석을 선택하여 예약하세요 (19:00 - 21:00)</p>
        </div>

        <div class="content">
            <div class="form-section">
                <h2 style="margin-bottom: 20px;">예약하기</h2>
                
                <div class="form-group">
                    <label for="studentName">학생 이름</label>
                    <input type="text" id="studentName" placeholder="이름을 입력하세요">
                </div>

                <div class="form-group">
                    <label for="classNum">반</label>
                    <input type="number" id="classNum" placeholder="반을 입력하세요" min="1">
                </div>

                <div class="form-group">
                    <label for="studentNum">번호</label>
                    <input type="number" id="studentNum" placeholder="번호를 입력하세요" min="1">
                </div>

                <div class="form-group">
                    <label>날짜 (오늘)</label>
                    <div class="date-display" id="dateDisplay"></div>
                    <input type="hidden" id="reservationDate">
                </div>

                <div class="form-group">
                    <label>시간대 선택</label>
                    <div class="time-slots" id="timeSlots">
                        <div class="time-slot" data-time="19:00-20:00">19:00-20:00</div>
                        <div class="time-slot" data-time="20:00-21:00">20:00-21:00</div>
                    </div>
                </div>

                <div class="seat-map">
                    <h3>좌석 선택</h3>
                    <div class="classroom" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;">
                        <div class="special-item" style="grid-row: 1 / 3; grid-column: 1;">선생님<br>자리</div>
                        
                        <div class="seat" data-seat="1"><span class="seat-number">1</span></div>
                        <div class="seat" data-seat="2"><span class="seat-number">2</span></div>
                        <div class="seat" data-seat="3"><span class="seat-number">3</span></div>
                        <div class="seat" data-seat="4"><span class="seat-number">4</span></div>
                        <div class="seat" data-seat="5"><span class="seat-number">5</span></div>
                        <div class="seat" data-seat="6"><span class="seat-number">6</span></div>

                        <div class="seat" data-seat="7"><span class="seat-number">7</span></div>
                        <div class="seat" data-seat="8"><span class="seat-number">8</span></div>
                        <div class="seat" data-seat="9"><span class="seat-number">9</span></div>
                        <div class="seat" data-seat="10"><span class="seat-number">10</span></div>
                        <div class="seat" data-seat="11"><span class="seat-number">11</span></div>
                        <div class="seat" data-seat="12"><span class="seat-number">12</span></div>

                        <div class="seat" data-seat="13"><span class="seat-number">13</span></div>
                        <div class="seat" data-seat="14"><span class="seat-number">14</span></div>
                        <div class="seat" data-seat="15"><span class="seat-number">15</span></div>
                        <div class="seat" data-seat="16"><span class="seat-number">16</span></div>
                        <div class="seat" data-seat="17"><span class="seat-number">17</span></div>
                        <div class="pillar special-item">기둥</div>
                        <div class="seat" data-seat="18"><span class="seat-number">18</span></div>

                        <div class="seat" data-seat="19"><span class="seat-number">19</span></div>
                        <div class="seat" data-seat="20"><span class="seat-number">20</span></div>
                        <div class="seat" data-seat="21"><span class="seat-number">21</span></div>
                        <div class="seat" data-seat="22"><span class="seat-number">22</span></div>
                        <div class="seat" data-seat="23"><span class="seat-number">23</span></div>
                        <div class="pillar special-item">기둥</div>
                        <div class="seat" data-seat="24"><span class="seat-number">24</span></div>

                        <div class="seat" data-seat="25"><span class="seat-number">25</span></div>
                        <div class="seat" data-seat="26"><span class="seat-number">26</span></div>
                        <div class="seat" data-seat="27"><span class="seat-number">27</span></div>
                        <div class="seat" data-seat="28"><span class="seat-number">28</span></div>
                        <div class="seat" data-seat="29"><span class="seat-number">29</span></div>
                        <div class="seat" data-seat="30"><span class="seat-number">30</span></div>
                        <div class="seat" data-seat="31"><span class="seat-number">31</span></div>

                        <div class="seat" data-seat="32"><span class="seat-number">32</span></div>
                        <div class="seat" data-seat="33"><span class="seat-number">33</span></div>
                        <div class="seat" data-seat="34"><span class="seat-number">34</span></div>
                        <div class="seat" data-seat="35"><span class="seat-number">35</span></div>
                        <div class="seat" data-seat="36"><span class="seat-number">36</span></div>
                        <div class="seat" data-seat="37"><span class="seat-number">37</span></div>
                        <div class="seat" data-seat="38"><span class="seat-number">38</span></div>

                        <div class="special-item pillar" style="grid-column: 1 / 3;">냉난방기</div>
                        <div class="seat" data-seat="39"><span class="seat-number">39</span></div>
                        <div class="seat" data-seat="40"><span class="seat-number">40</span></div>
                        <div class="seat" data-seat="41"><span class="seat-number">41</span></div>
                        <div class="seat" data-seat="42"><span class="seat-number">42</span></div>
                        <div class="seat" data-seat="43"><span class="seat-number">43</span></div>
                    </div>

                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-box available"></div>
                            <span>선택 가능</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box selected"></div>
                            <span>선택됨</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box reserved"></div>
                            <span>예약됨</span>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="makeReservation()">예약하기</button>
                <button class="btn btn-export" onclick="exportToExcel()">오늘 예약자 명단 엑셀로 다운로드</button>
            </div>

            <div class="reservations-list">
                <h2 style="margin-bottom: 20px;">예약 현황</h2>
                <div id="reservationsList"><div class="loading">데이터 로딩 중...</div></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ✅ Your Firebase configuration is now correctly placed here.
        const firebaseConfig = {
            apiKey: "AIzaSyDPnOtTMW-w6LD0hggKcFkYNGyJOPq1tEg",
            authDomain: "night-study-room-reservation.firebaseapp.com",
            projectId: "night-study-room-reservation",
            storageBucket: "night-study-room-reservation.appspot.com",
            messagingSenderId: "460809823747",
            appId: "1:460809823747:web:9d76154d519d0e40b89036",
            measurementId: "G-2L4SS21JQL"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 전역 변수
        let selectedTimes = [];
        let selectedSeat = null;
        let todaysReservations = []; // ✅ Today's reservations will be stored here

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Firebase has been initialized.');
            initializeDate();
            setupEventListeners();
            await loadTodaysReservations(); // Load data for today
        });

        // 날짜 초기화
        function initializeDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            
            document.getElementById('reservationDate').value = todayString;
            document.getElementById('dateDisplay').textContent = `${year}년 ${month}월 ${day}일`;
        }
        
        // 이벤트 리스너 설정 (시간 및 좌석)
        function setupEventListeners() {
            // Time Slot Listeners
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.addEventListener('click', function() {
                    const time = this.dataset.time;
                    this.classList.toggle('selected');
                    
                    if (selectedTimes.includes(time)) {
                        selectedTimes = selectedTimes.filter(t => t !== time);
                    } else {
                        selectedTimes.push(time);
                    }
                    updateSeatAvailability();
                });
            });

            // Seat Listeners
            document.querySelectorAll('.seat').forEach(seat => {
                seat.addEventListener('click', function() {
                    if (this.classList.contains('reserved')) return;
                    
                    // Un-select if clicking the same seat
                    if (this.classList.contains('selected')) {
                        this.classList.remove('selected');
                        selectedSeat = null;
                    } else {
                        // Select the new seat
                        document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedSeat = this.dataset.seat;
                    }
                });
            });
        }

        // ✅ OPTIMIZED: Load only today's reservations from Firebase
        async function loadTodaysReservations() {
            const date = document.getElementById('reservationDate').value;
            const listDiv = document.getElementById('reservationsList');
            listDiv.innerHTML = '<div class="loading">데이터 로딩 중...</div>';

            try {
                const q = query(collection(db, 'reservations'), where("date", "==", date));
                const querySnapshot = await getDocs(q);
                
                todaysReservations = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                displayReservations(todaysReservations);
                updateSeatAvailability();
                console.log(`Loaded ${todaysReservations.length} reservations for today.`);
            } catch (error) {
                console.error('Error loading reservations:', error);
                listDiv.innerHTML = '<div class="empty-state">데이터를 불러오는 데 실패했습니다. 관리자에게 문의하세요.</div>';
            }
        }

        // ✅ OPTIMIZED: Update seat map using local data (no database call)
        function updateSeatAvailability() {
            // 모든 좌석의 'reserved' 상태를 일단 초기화합니다.
            document.querySelectorAll('.seat').forEach(seat => seat.classList.remove('reserved'));

            const reservedSeats = new Set();

            if (selectedTimes.length === 0) {
                // [초기 로드 상태] 선택된 시간대가 없으면, 오늘 예약된 모든 좌석을 Set에 추가합니다.
                todaysReservations.forEach(r => {
                reservedSeats.add(r.seat);
                });
            } 
            else {
                // [시간대 선택 상태] 선택된 시간대가 있으면, 해당 시간대에 예약된 좌석만 필터링하여 Set에 추가합니다.
                todaysReservations.forEach(r => {
                    if (r.isCombined || selectedTimes.includes(r.time)) {
                        reservedSeats.add(r.seat);
                        }
                });
            }

            // 최종적으로 Set에 담긴 좌석 번호에 'reserved' 클래스를 적용합니다.
            reservedSeats.forEach(seatNum => {
                const seatEl = document.querySelector(`.seat[data-seat="${seatNum}"]`);
                if (seatEl) {
                    seatEl.classList.add('reserved');
                }
            });
        }

        // 예약하기
        window.makeReservation = async function() {
            const name = document.getElementById('studentName').value.trim();
            const classNum = document.getElementById('classNum').value.trim();
            const studentNum = document.getElementById('studentNum').value.trim();
            const date = document.getElementById('reservationDate').value;

            if (!name || !classNum || !studentNum || selectedTimes.length === 0 || !selectedSeat) {
                alert('모든 정보를 입력하고 시간대와 좌석을 선택해주세요.');
                return;
            }

            // ✅ OPTIMIZED: Check for duplicates using local data
            const isCombinedAttempt = selectedTimes.length === 2;
            const conflict = todaysReservations.find(r => {
                if (r.seat !== selectedSeat) return false;
                if (r.isCombined || isCombinedAttempt || selectedTimes.includes(r.time)) return true;
                return false;
            });

            if (conflict) {
                alert('해당 좌석은 선택하신 시간대에 이미 예약되어 있습니다.');
                return;
            }

            try {
                const reservationData = {
                    name, grade: '2', classNum, studentNum, date,
                    room: '융합실', seat: selectedSeat, 
                    createdAt: new Date().toISOString()
                };

                if (isCombinedAttempt) {
                    await addDoc(collection(db, 'reservations'), {
                        ...reservationData,
                        time: '19:00-21:00',
                        isCombined: true,
                    });
                } else {
                    await addDoc(collection(db, 'reservations'), {
                        ...reservationData,
                        time: selectedTimes[0],
                        isCombined: false,
                    });
                }
                
                alert('예약이 완료되었습니다!');
                clearForm();
                await loadTodaysReservations(); // Refresh data from Firebase
            } catch (error) {
                console.error('Error making reservation:', error);
                alert('예약 중 오류가 발생했습니다.');
            }
        };

        // 예약 현황 표시
        function displayReservations(reservations) {
            const listDiv = document.getElementById('reservationsList');
            if (reservations.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">오늘의 예약 내역이 없습니다.</div>';
                return;
            }

            const sorted = [...reservations].sort((a, b) => {
                if (a.time !== b.time) return a.time.localeCompare(b.time);
                return parseInt(a.seat) - parseInt(b.seat);
            });

            listDiv.innerHTML = sorted.map(r => `
                <div class="reservation-card" id="card-${r.id}">
                    <div class="reservation-info">
                        <h3>${r.name} (${r.grade}학년 ${r.classNum}반 ${r.studentNum}번)</h3>
                        <p><strong>좌석:</strong> ${r.seat}번</p>
                        <p><strong>시간:</strong> ${r.time}</p>
                    </div>
                    <div class="cancel-section">
                        <p style="color: #999; font-size: 14px; margin-bottom: 8px;">취소하려면 이름을 입력하세요:</p>
                        <div class="cancel-input-group">
                            <input type="text" class="cancel-input" id="cancel-${r.id}" placeholder="예약자 이름">
                            <button class="btn-cancel-confirm" onclick="confirmCancelReservation('${r.id}', '${r.name}')">취소 확인</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 예약 취소
        window.confirmCancelReservation = async function(docId, originalName) {
            const inputName = document.getElementById(`cancel-${docId}`).value.trim();
            if (inputName !== originalName) {
                alert('예약자 이름이 일치하지 않습니다.');
                return;
            }

            if (confirm(`'${originalName}' 학생의 예약을 정말로 취소하시겠습니까?`)) {
                try {
                    await deleteDoc(doc(db, 'reservations', docId));
                    alert('예약이 취소되었습니다.');
                    await loadTodaysReservations(); // Refresh data from Firebase
                } catch (error) {
                    console.error('Error canceling reservation:', error);
                    alert('취소 중 오류가 발생했습니다.');
                }
            }
        };
        
        // 폼 초기화
        function clearForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('classNum').value = '';
            document.getElementById('studentNum').value = '';
            document.querySelectorAll('.time-slot.selected').forEach(s => s.classList.remove('selected'));
            document.querySelectorAll('.seat.selected').forEach(s => s.classList.remove('selected'));
            selectedTimes = [];
            selectedSeat = null;
        }

        // 엑셀 다운로드
        window.exportToExcel = function() {
            const password = prompt('엑셀 다운로드 비밀번호를 입력하세요:');
            if (password !== '0000') {
                if (password !== null) alert('비밀번호가 올바르지 않습니다.');
                return;
            }

            if (todaysReservations.length === 0) {
                alert('오늘 예약 내역이 없습니다.');
                return;
            }

            const sorted = [...todaysReservations].sort((a, b) => {
                if (a.time !== b.time) return a.time.localeCompare(b.time);
                return parseInt(a.seat) - parseInt(b.seat);
            });

            let csvContent = '\uFEFF날짜,시간대,이름,학년,반,번호,좌석번호\n';
            sorted.forEach(r => {
                const row = `${r.date},${r.time},${r.name},${r.grade},${r.classNum},${r.studentNum},${r.seat}\n`;
                csvContent += row;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const date = document.getElementById('reservationDate').value;
            link.setAttribute('download', `야자실예약_${date}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
    </script>
</body>
</html>
